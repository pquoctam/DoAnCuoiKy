@model Cart

@{
    var cartItems = Model?.CartItem ?? new List<CartItem>();
    ViewData["Title"] = "Thông tin đơn hàng";

    var tongTien = cartItems.Sum(item =>
    {
        var giaMon = item.MaMonNavigation?.GiaBan ?? 0;
        var tongTopping = item.CartItemTopping?.Sum(t => t.MaToppingNavigation?.GiaTopping ?? 0) ?? 0;
        return (decimal)(giaMon + tongTopping) * item.SoLuong;
    });

    var giamGia = 0M;
    var loaiKM = Context.Session.GetString("LoaiKM");
    var giaTriKMString = Context.Session.GetString("GiaTriKM");
    decimal giaTriKM = 0;
    decimal.TryParse(giaTriKMString, out giaTriKM);

    if (loaiKM == "PhanTram")
    {
        giamGia = tongTien * giaTriKM / 100;
    }
    else if (loaiKM == "TienMat")
    {
        giamGia = giaTriKM;
    }

    var tongTienSauGiam = tongTien - giamGia;
}

<h2 class="order-title">THÔNG TIN ĐƠN HÀNG</h2>

<div class="order-wrapper">
    <form asp-action="ThanhToan" method="post" class="order-left">
        @Html.AntiForgeryToken()

        <h4 class="section-title">GIAO HÀNG ĐẾN</h4>
        <div class="input-group">
            <input type="text" name="HoTen" placeholder="Họ tên *" value="@ViewBag.HoTen" required />
            <input type="text" name="SoDienThoai" placeholder="Số điện thoại *" value="@ViewBag.SoDienThoai" required />
        </div>

        <input type="text" name="DiaChiGiaoHang" placeholder="Địa chỉ *" required />
        <textarea name="GhiChu" placeholder="Ghi chú"></textarea>

        <h4 class="section-title2">PHƯƠNG THỨC VẬN CHUYỂN</h4>
        <div class="form-group">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="PhuongThucGiaoHang" id="giaoTanNoi"
                    value="GiaoTanNoi" checked />
                <label class="form-check-label" for="giaoTanNoi">Giao hàng tận nơi (+10,000 đ)</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="PhuongThucGiaoHang" id="layTaiCuaHang"
                    value="LayTaiCuaHang" />
                <label class="form-check-label" for="layTaiCuaHang">Hẹn lấy tại cửa hàng</label>
            </div>
        </div>

        <div id="chonCuaHang" style="display:none;">
            <div class="form-group">
                <label for="TinhThanh">Tỉnh thành</label>
                <select class="form-control" id="TinhThanh" name="TinhThanh">
                    <option value="Hồ Chí Minh">Hồ Chí Minh</option>
                    <option value="Hà Nội">Hà Nội</option>
                    <option value="Đà Nẵng">Đà Nẵng</option>
                </select>
            </div>
            <div class="form-group">
                <label for="CuaHang">Cửa hàng</label>
                <select class="form-control" id="CuaHang" name="CuaHang">
                    <option value="">Chọn cửa hàng *</option>
                </select>
            </div>
        </div>

        <h4 class="section-title2">PHƯƠNG THỨC THANH TOÁN</h4>
        <div class="form-group2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="PhuongThucThanhToan" id="tienMat" value="TienMat" />
                <label class="form-check-label" for="tienMat">Tiền Mặt</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="PhuongThucThanhToan" id="viMoMo" value="ViMoMo"
                    checked />
                <label class="form-check-label" for="viMoMo">PayPal</label>
            </div>
            <div id="paypal-button-container" style="margin-top: 1.5rem; display: none;"></div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="PhuongThucThanhToan" id="viDienTu"
                    value="ViDienTu" />
                <label class="form-check-label" for="VNPAY">VNPAY</label>
            </div>
        </div>

        <div class="form-group">
            <h4 class="section-title3">GHI CHÚ ĐƠN HÀNG</h4>
            <textarea class="form-control" id="GhiChuDonHang" name="GhiChu" placeholder="Ghi chú"></textarea>
        </div>

        <button type="submit" class="btn-submit">XÁC NHẬN ĐƠN HÀNG</button>
    </form>

    <!-- Modal hiển thị voucher -->
    <div id="voucherModal" class="modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;">
        <div class="modal-content"
            style="background:white; padding:1.5rem; width:400px; margin:10% auto; border-radius:8px; position:relative;">
            <span class="close" onclick="dongModalVoucher()"
                style="position:absolute; top:10px; right:20px; font-size:24px; cursor:pointer;">&times;</span>
            <h4 style="margin-bottom:1rem;">Chọn voucher</h4>

            @if (ViewBag.VoucherList != null && ((List<MaGiamGia>)ViewBag.VoucherList).Count > 0)
            {
                <ul style="list-style:none; padding:0;">
                    @foreach (var v in (List<MaGiamGia>)ViewBag.VoucherList)
{
    <div class="voucher-card">
        <div class="voucher-info">
            <span class="voucher-code">@v.MaCode</span>
            <span class="voucher-type">
                @(v.KhuyenMai.LoaiKM == "PhanTram"
                    ? $"{v.KhuyenMai.GiaTri}% giảm"
                    : $"{((int)v.KhuyenMai.GiaTri):N0} đ")
            </span>
            <span class="voucher-expiry">HSD: @v.KhuyenMai.NgayKetThuc.ToString("dd/MM/yyyy")</span>
        </div>
        <button type="button" class="btn-quick-apply" onclick="chonVoucher('@v.MaCode')">Chọn</button>
    </div>
}
                </ul>
            }
            else
            {
                <p>Hiện không có voucher khả dụng.</p>
            }
        </div>
    </div>

    <div class="order-right">
        <div class="order-header">
            <h4>CHI TIẾT ĐƠN HÀNG</h4>
            <i class="fas fa-pen edit-icon"></i>
        </div>

        @foreach (var item in cartItems)
        {
            var toppings = item.CartItemTopping ?? new List<CartItemTopping>();
            var giaTopping = toppings.Sum(t => t.MaToppingNavigation?.GiaTopping ?? 0);
            var giaMon = item.MaMonNavigation?.GiaBan ?? 0;
            var thanhTien = (giaMon + giaTopping) * item.SoLuong;

            <div class="order-item">
                <img src="~/images/ThucDon/@item.MaMonNavigation?.HinhAnh" class="item-image" />
                <div class="item-info">
                    <p class="item-name">@item.MaMonNavigation?.TenMon</p>
                    <p class="item-qty">x @item.SoLuong</p>
                    <p class="item-price">+ @thanhTien.ToString("N0") đ</p>
                    @if (toppings.Any())
                    {
                        <ul class="topping-list">
                            @foreach (var tp in toppings)
                            {
                                <li>@tp.MaToppingNavigation?.TenTopping - @((tp.MaToppingNavigation?.GiaTopping ??
                                                            0).ToString("N0")) đ</li>
                            }
                        </ul>
                    }
                </div>
            </div>
        }

        <div class="order-subtotal">
            <span>Chi phí tạm tính</span>
            <span class="subtotal-amount">@tongTien.ToString("N0") đ</span>
        </div>

        <p class="vat-note">Đã bao gồm giá thuế VAT 8%</p>

        <div class="promotion-wrapper">
            <div class="voucher-header">
                <h4 class="promotion1-title">Áp dụng khuyến mãi</h4>
                <button type="button" class="btn-voucher">Duyệt voucher</button>
            </div>
            <div class="voucher-input">
                <input type="text" placeholder="Nhập mã phiếu quà tặng" name="GiftCode" />
                <button type="submit" class="btn-apply">Áp dụng</button>
            </div>

            <div class="coupon-section">
                <h4 class="promotion2-title">Áp dụng coupon</h4>
                <form asp-action="ApDungCoupon" method="post" class="coupon-input">
                    @Html.AntiForgeryToken()
                    <input type="text" name="MaCoupon" placeholder="Nhập mã khuyến mãi"
                        value="@Context.Session.GetString("MaCoupon")" />
                    <button type="submit" class="btn-apply">Áp dụng</button>
                </form>
                @if (TempData["MaCouponSuccess"] != null)
                {
                    <p style="color: green; font-weight: 600;">@TempData["MaCouponSuccess"]</p>
                }
                else if (TempData["MaCouponError"] != null)
                {
                    <p style="color: red; font-weight: 600;">@TempData["MaCouponError"]</p>
                }
            </div>
        </div>

        @if (giamGia > 0)
        {
            <div class="order-subtotal">
                <span>Giảm giá</span>
                <span class="subtotal-amount text-danger">-@giamGia.ToString("N0") đ</span>
            </div>
        }

        <div class="order-total">
            <span class="total-label">Tổng Cộng</span>
            <span class="total-amount">@tongTienSauGiam.ToString("N0") đ</span>
        </div>
    </div>
</div>


@section Scripts {
    <script
        src="https://www.paypal.com/sdk/js?client-id=AYKCr7Gy0LjpMpdqcck8Xt_bEVcA0YjD8Ep7GM9KzA0HYLOgjgTc6G0IsyxXup6HoilL5pIr2eSrEJWV&currency=USD&locale=vi_VN"></script>

    <script>
        const paypalBtn = document.getElementById("paypal-button-container");
        const radioPayPal = document.getElementById("viMoMo");

        // Khi chọn PayPal thì hiển thị nút
        radioPayPal.addEventListener("change", function () {
            if (this.checked) {
                paypalBtn.style.display = "block";
            }
        });

        // Khi chọn phương thức khác thì ẩn nút PayPal
        document.querySelectorAll("input[name='PhuongThucThanhToan']").forEach(function (radio) {
            if (radio.id !== "viMoMo") {
                radio.addEventListener("change", function () {
                    paypalBtn.style.display = "none";
                });
            }
        });

        paypal.Buttons({
            createOrder: function (data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '@tongTien.ToString("0.00").Replace(",", "").Replace(".", ".")' // PayPal nhận dạng kiểu "10.00"
                        }
                    }]
                });
            },
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    alert('Thanh toán thành công bởi ' + details.payer.name.given_name + '!');
                    window.location.href = "/ThanhToan/HoanTat";
                });
            }
        }).render('#paypal-button-container');
    </script>

    <script>
        function moModalVoucher() {
            document.getElementById("voucherModal").style.display = "block";
        }
        function dongModalVoucher() {
            document.getElementById("voucherModal").style.display = "none";
        }
        function chonVoucher(ma) {
            document.querySelector('input[name="MaCoupon"]').value = ma;
            document.querySelector('.coupon-input').submit();
        }

        // Gắn sự kiện cho nút “Duyệt voucher”
        document.querySelector('.btn-voucher').addEventListener('click', moModalVoucher);
    </script>
}


@section Styles {
    <style>
        .order-title {
            text-align: center;
            color: #9a3324;
            font-size: 2.2rem;
            font-weight: 900;
            margin-top: 8rem;
        }

        .order-wrapper {
            max-width: 1200px;
            margin: 3rem auto 5rem auto;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .order-left,
        .order-right {
            flex: 1;
            min-width: 300px;
        }

        .section-title {
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
        }

        input[type="text"],
        textarea {
            width: 100%;
            font-size: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #ccc;
            margin-bottom: 1.5rem;
            height: 3.25rem;
        }

        textarea {
            resize: none;
            height: 100px;
        }

        .btn-submit {
            background-color: #9a3324;
            color: white;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-submit:hover {
            background-color: #f8b02d;
            color: black;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 900;
            margin-bottom: 1.75rem;
            color: #333;
            text-transform: uppercase;
        }

        .section-title2 {
            font-size: 1.3rem;
            font-weight: 900;
            border-bottom: 1px solid #ccc;
            margin-top: 2.5rem;
            color: #333;
            text-transform: uppercase;
            padding-bottom: 1rem;
            padding-top: 1rem;
        }

        .section-title3 {
            font-size: 1.3rem;
            font-weight: 900;
            margin-top: 1.5rem;
            color: #333;
            text-transform: uppercase;
            padding-bottom: 1rem;
            padding-top: 1rem;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            /* khoảng cách giữa chấm và chữ */
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #ccc;
            padding-bottom: 1rem;
            padding-top: 1rem;
        }

        .form-check-input {
            margin: 0;
            accent-color: red;
            width: 18px;
            height: 18px;
        }

        .form-check-label {
            margin: 0;
            font-weight: 500;
        }


        /* Group chọn tỉnh và cửa hàng */
        .form-group {
            margin-bottom: 1rem;
        }

        .label {
            font-weight: 900;
            margin-bottom: 1rem;
            margin-top: 3.5rem;
            display: block;
            color: #222;
        }

        select,
        textarea,
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.2s ease;
        }

        select:focus,
        textarea:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #f44336;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2);
        }

        .promotion-wrapper {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .promotion1-title {
            font-size: 1.2rem;
            font-weight: 900;
            margin-bottom: 1.25rem;
            color: #333;
        }

        .promotion2-title {
            font-size: 1.2rem;
            font-weight: 900;
            margin-bottom: 1.25rem;
            color: #333;
            margin-top: 2rem;
        }

        .voucher-section,
        .coupon-section {
            margin-bottom: 1.25rem;
        }

        .voucher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .btn-voucher {
            background-color: #ffc107;
            font-weight: 800;
            padding: 0.75rem 1rem;
            border: none;
            cursor: pointer;
            border-radius: 0.4rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
        }

        .voucher-input,
        .coupon-input {
            display: flex;
        }

        .voucher-input input,
        .coupon-input input {
            flex: 1;
            padding: 1rem;
            border-radius: 6px 0 0 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        .btn-apply {
            background-color: #e31937;
            color: white;
            font-weight: 900;
            font-size: 0.85rem;
            text-transform: uppercase;
            border: none;
            border-radius: 0 6px 6px 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            height: 3.3rem;
        }

        .btn-apply:hover {
            background-color: #c10014;
        }

        /* Ghi chú đơn hàng */
        textarea {
            min-height: 100px;
        }

        /* Nút tiếp theo */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            color: #fff;
            background-color: #d70018;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .btn:hover {
            background-color: #c10014;
        }

        .order-right {
            background-color: #f9f6ef;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: auto;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .order-header h4 {
            font-weight: bold;
            font-size: 1.5rem;
            margin: 0;
        }

        .edit-icon {
            color: #333;
            cursor: pointer;
        }

        .order-item {
            display: flex;
            margin-bottom: 1.2rem;
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .item-info {
            flex-grow: 1;
            margin-bottom: 1rem;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .item-qty,
        .item-price {
            margin-bottom: 0.2rem;
        }

        .item-price {
            font-weight: bold;
            text-align: right;
            white-space: nowrap;
            transform: translateY(-2.75rem);
        }

        .topping-list {
            list-style-type: none;
            font-size: 0.9rem;
            color: #555;
            transform: translateY(-0.75rem);
        }

        .order-subtotal {
            display: flex;
            justify-content: space-between;
            border-top: 1px dashed #ccc;
            margin-top: 1.25rem;
            padding-top: 0.8rem;
            font-size: 1rem;
            color: #333;
        }

        .vat-note {
            color: #9a3324;
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            border-bottom: 1px solid #ccc;
            padding-bottom: 1rem;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #333;
            margin-top: 1rem;
            padding-top: 0.8rem;
        }

        .total-label {
            font-size: 1.2rem;
            font-weight: 900;
            margin-top: 0.5rem;
        }

        .total-amount {
            font-size: 1.5rem;
            font-weight: 900;
            color: #9a3324;
            margin-top: 0.5rem;
        }

        .voucher-card {
    background: #fffaf5;
    border: 2px dashed #a94442;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    position: relative;
}

.voucher-info {
    font-size: 0.9rem;
    line-height: 1.6;
}

.voucher-code {
    color: #d32f2f;
    font-weight: bold;
    font-size: 1.1rem;
    display: block;
}

.voucher-type {
    display: block;
    margin-top: 0.2rem;
}

.voucher-expiry {
    font-size: 0.8rem;
    color: #888;
    display: block;
}

.btn-quick-apply {
    background-color: #a94442;
    color: #fff;
    padding: 0.3rem 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    float: right;
    margin-top: -2.5rem;
}
    </style>

}